Dot {
 name Dot_Link
 help "Dot avec une connection automatique.\n\nLe node passe en rouge quand le input est masqu√© \"hide input\".\n\n\nRapel de raccourci Nuke:\n\nHide input: alt + H\n"
 onCreate "import nuke\ntry:\n    # < Nuke 11\n    import PySide.QtCore as QtCore\n    import PySide.QtGui as QtGui\nexcept:\n    # >= Nuke 11\n    import PySide2.QtCore as QtCore\n    import PySide2.QtGui as QtGui\n\nclass MM_easySearch(QtGui.QWidget):\n\n    def __init__(self, node):\n        super(self.__class__, self).__init__()\n\n        self.node = node\n\n        layout = QtGui.QVBoxLayout()\n        layout.setAlignment(QtCore.Qt.AlignTop)\n        self.setLayout(layout)\n\n        tmpCompleter = QtGui.QCompleter(self.allNodesNames(), self)\n        tmpCompleter.setCompletionMode(QtGui.QCompleter.UnfilteredPopupCompletion)\n\n        lbl = QtGui.QLabel(self)\n        lbl.setText(\"<font color='green'><b>Node to link:\")\n        layout.addWidget(lbl)\n\n        self.txtField = QtGui.QLineEdit()\n        self.txtField.textChanged.connect(self.updateList)\n        self.txtField.setText(self.node.knob(backupTxtFieldName).value())\n        self.txtField.setCompleter(tmpCompleter)\n        layout.addWidget(self.txtField)\n\n    def makeUI(self):\n        return self\n\n    def updateValue(self):\n        pass\n\n    def allNodesNames(self):\n        nodeNames = \[]\n\n        allNodes = nuke.allNodes()\n        excludedTypes = \[\"Viewer\", \"BackdropNode\", \"StickyNote\"]\n        excludedNodes = \[]\n        for t in excludedTypes:\n            curExclude = nuke.allNodes(t)\n            for e in curExclude:\n                excludedNodes.append(e\[\"name\"].value())\n        \n        for n in allNodes:\n            if n\[\"name\"].value() not in excludedNodes:\n                nodeNames.append(n\[\"name\"].value())\n\n        return nodeNames\n\n    def updateList(self):\n        wordList = \[]\n        curTxt = self.txtField.text()\n\n        allNodes = self.allNodesNames()        \n        if len(curTxt):\n            for n in allNodes:\n                if curTxt.lower() in n.lower():\n                    wordList.append(n)\n\n            tmpCompleter = QtGui.QCompleter(wordList, self)\n            tmpCompleter.setCompletionMode(QtGui.QCompleter.UnfilteredPopupCompletion)\n            self.txtField.setCompleter(tmpCompleter)\n\n            if curTxt in allNodes:\n                k = self.node.knob(backupTxtFieldName)\n                k.setValue(curTxt)\n        else:\n            k = self.node.knob(backupTxtFieldName)\n            k.setValue(\"\")\n                \nif __name__ == '__main__':\n    searchBarName = \"MM_easySearch\"\n    backupTxtFieldName = \"MM_inputName_hidden\"\n    \n    node = nuke.thisNode()\n    \"\"\"\n    existingKnobs = node.knobs()\n    for k in existingKnobs:\n        if k == searchBarName or k == backupTxtFieldName:\n            node.removeKnob(existingKnobs\[k])\n\n    tmp = nuke.String_Knob(backupTxtFieldName)\n    tmp.setVisible(False)\n    node.addKnob(tmp)\n\n    knob = nuke.PyCustom_Knob(searchBarName, \"\", \"MM_easySearch(nuke.thisNode())\" ) \n    node.addKnob(knob)\n    \"\"\"\n\nif not nuke.thisNode().knob('created_1').value():\n    nuke.thisNode().showControlPanel()\n    nuke.thisNode().knob('created_1').setValue(True)\n    nuke.thisNode().knob('applyPresets').setValue(True)"
 knobChanged "listenedKnobs = \['MM_inputName_hidden', 'selected', 'inputChange']\n\nif nuke.thisKnob().name() in listenedKnobs:\n    baseLabel = 'Link to: <font size = 3 color=\"green\">'\n    nothingLabel = 'Link to: <font size = 3 color=\"red\">Nothing'\n\n    def tryConnectDot():\n        nodes = \[node.name() for node in nuke.allNodes()]\n        inputName = nuke.thisNode().knob('MM_inputName_hidden').value()\n\n        if inputName in nodes:\n            if nuke.thisNode().input(0) is None or inputName != nuke.thisNode().input(0).name():\n                nuke.thisNode().setInput(0, None)\n                nuke.thisNode().setInput(0, nuke.toNode(inputName))\n                nuke.thisNode().knob('label').setValue(baseLabel+inputName)\n        else:\n            if nuke.thisNode().input(0) is not None:\n                nuke.thisNode().setInput(0, None)\n                nuke.thisNode().knob('label').setValue(nothingLabel)\n    tryConnectDot()\n\nelif nuke.thisKnob().name() == 'hide_input':\n    if nuke.thisNode().knob('hide_input').value() == False:  # if we unhide\n        nuke.thisNode()\['tile_color'].setValue(nuke.thisNode()\['gl_color'].value())\n    else:  # if we hide\n        nuke.thisNode()\['gl_color'].setValue(nuke.thisNode()\['tile_color'].value())\n        nuke.thisNode()\['tile_color'].setValue(3507945727)\n\nelif nuke.thisKnob().name() == 'convert':\n    newPostage = nuke.createNode('PostageStamp')\n    canSet = newPostage.canSetInput(0, nuke.thisNode().input(0))\n    nuke.delete(newPostage)\n\n    if canSet:\n        saveX = nuke.thisNode().xpos()\n        saveY = nuke.thisNode().ypos()\n        nuke.thisNode().selectOnly()\n    \n        # Create a node to save output connections\n        nodeTemp = nuke.createNode('Dot')\n        nuke.thisNode().selectOnly()\n        \n        path = nukescripts.getNukeUserFolder() + '/tmp.nk'\n        nuke.nodeCopy(path)\n        nuke.delete(nuke.thisNode())\n        \n        with open(path, 'r') as f:\n            content = f.read()\n    \n        content = content.split('\\n')\n    \n        for index, line in enumerate(content):\n            if 'Dot \{' in line:\n                content\[index] = line.replace('Dot \{', 'PostageStamp \{')\n    \n            elif 'PostageStamp \{' in line:\n                content\[index] = line.replace('PostageStamp \{', 'Dot \{')\n    \n            elif 'name Post_Link' in line and 'line.replace' not in line:\n                content\[index] = line.replace('name Post_Link', 'name Dot_Link')\n    \n            elif 'name Dot_Link' in line and 'line.replace' not in line:\n                content\[index] = line.replace('name Dot_Link', 'name Post_Link')\n    \n            elif 'postage_stamp true' in line and 'line.replace' not in line:\n                content\[index] = line.replace('postage_stamp true', '')\n    \n            elif 'cached true' in line and 'line.replace' not in line:\n                content\[index] = line.replace('cached true', '')\n    \n            elif 'disable true' in line and 'line.replace' not in line:\n                content\[index] = line.replace('disable true', '')\n    \n            elif 'dope_sheet true' in line and 'line.replace' not in line:\n                content\[index] = line.replace('dope_sheet true', '')\n    \n            elif 'bookmark true' in line and 'line.replace' not in line:\n                content\[index] = line.replace('bookmark true', '')\n    \n        content = '\\n'.join(content)\n    \n        with open(path, 'w') as f:\n            f.write(content)\n        \n        node = nuke.nodePaste(path)\n        if node.knob('convert').value():\n            node.setXYpos(saveX-34, saveY)\n            node.knob('postage_stamp').setValue(True)\n        else:\n            node.setXYpos(saveX+34, saveY)\n    \n        nodeTemp.setInput(0, node)\n        nuke.delete(nodeTemp)\n    \n        node.setInput(0, nuke.toNode(node.knob('MM_inputName_hidden').value()))\n        node.setSelected(False)\n        node.showControlPanel()\n    \n        import os\n        os.remove(path)\n    else:\n        nuke.message('Cannot connect a postage stamp to this node')\n        nuke.thisNode().knob('convert').setValue(False)\n        # Add the flag KNOB_CHANGED_ALWAYS\n        nuke.thisNode().knob('convert').setFlag(0x00010000)\n\nelif nuke.thisKnob().name() == 'applyPresets':\n    savePresets = nuke.thisNode().knob('savePresets').value()\n    applyPresets = nuke.thisNode().knob('applyPresets').value()\n    nuke.thisNode().knob('btname').setValue('')\n\n    if savePresets != '' and applyPresets:\n        knobsToDelete = \[knob for knob in nuke.thisNode().allKnobs() if 'n_' in knob.name()]\n        for knob in knobsToDelete:\n            nuke.thisNode().removeKnob(knob)\n\n        knobsToAdd = savePresets.split(',')\n        knobsToAdd.pop(-1)\n        for knobT in knobsToAdd:\n            nametext = knobT.split('_')\[-1]\n            nameknob = knobT\n\n            kn = nuke.nuke.PyScript_Knob(nameknob, nametext, \"nuke.thisNode().knob('MM_inputName_hidden').setValue(\\'\"+nametext+\"\\')\")\n            countCustoms = len(\[knob for knob in nuke.thisNode().allKnobs() if 'n_' in knob.name()])\n            if countCustoms % 4 == 0:\n                kn.setFlag(nuke.STARTLINE)\n            nuke.thisNode().addKnob(kn)\n            \nif nuke.thisKnob().name() == 'MM_inputName_hidden':\n    v = nuke.thisNode().knob('MM_inputName_hidden').value()\n    nuke.thisNode().knob('btname').setValue(v)\n    "
 tile_color 0xd11700ff
 label "Link to: <font size = 3 color=\"red\">Nothing"
 note_font_color 0x595959ff
 selected true
 hide_input true
 addUserKnob {20 FTDOT l "Dot Link"}
 addUserKnob {52 MM_easySearch l "" -STARTLINE T MM_easySearch(nuke.thisNode())}
 addUserKnob {22 python l INVISIBLE t "If it's not automatically done so use this button to reconnect the Dot to the input Node." -STARTLINE +INVISIBLE T "def getNode(nodeName):\n nodeToConnect = None\n for node in nuke.allNodes(): \n  if node.name() == nodeName: \n   return node \n\nnuke.thisNode().setInput(0,getNode(nuke.thisNode()\['input_node_2'].value()  ))"}
 addUserKnob {41 hide_input_1 l "Hide Input" T hide_input}
 addUserKnob {6 convert l "Postage Stamp" t "Display a small image on this node in Node Graph indicating its input." -STARTLINE}
 addUserKnob {1 savePresets l INVISIBLE +INVISIBLE}
 savePresets n_Master,n_Master_Undisto,n_Master_Denoise,n_Roto,n_Key,n_Matte,n_Camera,n_Format_Undisto,n_CG,
 addUserKnob {1 btname l INVISIBLE +INVISIBLE}
 addUserKnob {6 applyPresets l INVISIBLE +INVISIBLE +STARTLINE}
 applyPresets true
 addUserKnob {6 created_1 l INVISIBLE -STARTLINE +INVISIBLE}
 created_1 true
 addUserKnob {26 FT2 l " " T "                                                                                                                   "}
 addUserKnob {26 FTools l " " t "FranklinVFX.com\n" -STARTLINE T "<font color=\"#1C1C1C\"> Franklin VFX - 2018"}
 addUserKnob {1 MM_inputName_hidden +HIDDEN}
}
